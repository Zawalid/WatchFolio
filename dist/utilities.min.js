import{auth,onAuthStateChanged,sendEmailVerification,sendPasswordResetEmail,signOut,updateProfile,updateEmail,updatePassword,getStorage,ref,uploadString,getDownloadURL,reauthenticateWithCredential,EmailAuthProvider,GoogleAuthProvider,getSignInErrorMessage,db,doc,getDoc,updateDoc,setDoc,deleteDoc,deleteObject,linkWithPopup,unlink}from"/firebaseApp.min.js";const showPassword=()=>{document.querySelectorAll(".password_input").forEach(t=>{const a=t.nextElementSibling;document.addEventListener("click",e=>{"show_password"===e.target.id&&("password"==t.type&&""!=t.value?(t.type="text",a.className="fa-solid fa-eye-slash absolute z-30 right-3 top-1/2 cursor-pointer text-sm text-textColor2"):(t.type="password",a.className="fa-solid fa-eye absolute z-30 right-3 top-1/2 cursor-pointer text-sm text-textColor2")),t?.contains(e.target)||a?.contains(e.target)||"text"!=t?.type||(t.type="password",a.className="fa-solid fa-eye absolute z-30 right-3 top-1/2 cursor-pointer text-sm text-textColor2")})})},isValidPassword=()=>{var e=document.querySelector("[name='password']");const t=document.getElementById("chars_long_validation"),a=document.getElementById("special_chars_validation"),s=document.getElementById("numbers_validation"),o=document.getElementById("uppercase_validation"),n=document.getElementById("lowercase_validation"),r="fa-regular fa-check-circle text-red-300 mr-3";return e.addEventListener("input",function(){function e(e,t){t.className=e?"fa-solid fa-check-circle text-green-500  mr-3":r}e(8<=this.value.length,t),e(this.value.match(/[^a-zA-Z0-9]/g),a),e(this.value.match(/[0-9]/g),s),e(this.value.match(/[A-Z]/g),o),e(this.value.match(/[a-z]/g),n)}),t.className!==r&&a.className!==r&&s.className!==r&&o.className!==r&&n.className!==r},showMessage=(e,t)=>{const a=document.getElementById("message");"error"===t?a.classList.replace("bg-thirdAccent","bg-red-700"):a.classList.replace("bg-red-700","bg-thirdAccent"),a.textContent=e,a.classList.replace("-top-1/2","top-5"),setTimeout(()=>{a.classList.replace("top-5","-top-1/2")},4e3)},handleConnection=()=>{const e=document.getElementById("connectionStatus"),t=()=>{e.classList.replace("-bottom-14","bottom-3"),setTimeout(()=>{e.classList.replace("bottom-3","-bottom-14")},3e3)};window.addEventListener("online",()=>{e.lastElementChild.innerText="Back online",e.classList.replace("text-textColor2","text-primaryAccent"),t()}),window.addEventListener("offline",()=>{e.lastElementChild.innerText="No  connection",e.classList.replace("text-primaryAccent","text-textColor2"),t()})},toggleList=(handleConnection(),["load","hashchange"].forEach(e=>{window.addEventListener(e,e=>{if("#watchlist"===window.location.hash){const t=[...document.querySelectorAll("#watchList_toggler")].find(e=>"flex"===window.getComputedStyle(e).display);checkIfUserIsLoggedIn().then(e=>getDoc(doc(db,"watchList",e.uid)).then(e=>{e.exists()&&t.dispatchEvent(new Event("click"))})).catch(()=>{t.dispatchEvent(new Event("click"))})}else"#favorites"===window.location.hash?[...document.querySelectorAll("#favoritesList_toggler")].find(e=>"flex"===window.getComputedStyle(e).display).dispatchEvent(new Event("click")):"#account"===window.location.hash&&checkIfUserIsLoggedIn().then(()=>{document.getElementById("account_toggler").dispatchEvent(new Event("click"))}).catch(()=>{window.location.href="/authentication"})})}),(e,t,a,s)=>{document.querySelectorAll("#"+e).forEach(e=>{e.addEventListener("click",function(){"watchList"===t.id?s("watched"):s("shows"),t.classList.toggle("show"),this.classList.add("active"),window.matchMedia("(max-width: 768px)").matches?(document.getElementById("nav").appendChild(a),a.classList.toggle("hidden")):(t.appendChild(a),a.classList.remove("hidden"))})})}),closeList=(t,a,s,o)=>{document.addEventListener("click",e=>{a.contains(e.target)||e.target.closest("#"+t)||e.target.closest("#downloadList")||s.contains(e.target)||(a.classList.remove("show"),s.classList.add("hidden"),document.querySelectorAll("#"+t).forEach(e=>{e.classList.remove("active")}),"watchList"===a.id?o("watched"):o("shows"))})},displayShow=async(e,t)=>{e=await(await fetch("https://api.tvmaze.com/shows/"+e)).json();return`
  <div class="flex items-center justify-between" >
<a href="show?id=${e.id}" class="flex items-center gap-3 " data-id="${e.id}" >
<img src="${e.image?.medium||"/imgs/placeholder.png"}" alt="" class="w-[100px] rounded-lg" >
<h3 class="text-textColor font-bold text-lg">${e.name} </h3>
</a>
<i class="fa-solid fa-trash text-textColor2 transition-colors hover:text-secondaryAccent duration-300 text-lg cursor-pointer" id="${"favoritesList"===t.id?"removeFromFavoriteList":"removeFromWatchList"}"></i>
</div>
`},displayList=(t,a,s,o)=>{t.forEach(e=>{e.addEventListener("click",function(){t.forEach(e=>e.classList.remove("active")),this.classList.add("active"),a.dataset["current_"+s]=this.dataset[s],hideSearchInput(document.querySelector("input[name='search'].show")),o(this.dataset[s])})})},removeFromList=(a,s,o,n,r,i)=>{document.addEventListener("click",e=>{if(e.target.closest("#"+a)){e=e.target.closest("#"+a).previousElementSibling.dataset.id;const t=s.dataset["current_"+o];window.location.href.includes("show?id="+e)&&document.querySelectorAll(`#overview button[data-${o}]`).forEach(e=>{e.dataset[o]==t&&(e.innerHTML=n[t].defaultButton||n.defaultButton)}),i(e,n[t]),r(t)}})},clearList=(s,o,n,r)=>{const i=s.querySelector("#clear_confirmation");s.querySelector("#actions #clear").addEventListener("click",()=>{const a="watchList"===s.id?"shows":"list";0<o[s.dataset["current_"+n]][a].size&&i.classList.replace("hidden","flex"),i.addEventListener("click",e=>{if(e.target.closest("#no")&&i.classList.replace("flex","hidden"),e.target.closest("#yes")){i.classList.replace("flex","hidden");const t=s.dataset["current_"+n];window.localStorage.setItem(t,""),o[t][a].clear(),r(t),window.location.pathname.includes("show")&&document.querySelectorAll("#overview button").forEach(e=>{e.dataset[n]==t&&(e.innerHTML=o[t].defaultButton||o.defaultButton)})}})})},sortList=s=>{const e=e=>{var t=[...s.querySelectorAll("[data-id]")];let a="AZ"===e?t.toSorted((e,t)=>e.querySelector("h3").innerText.localeCompare(t.querySelector("h3").innerText)):t.toSorted((e,t)=>e.querySelector("h3").innerText.localeCompare(t.querySelector("h3").innerText)).toReversed();a=a.map(e=>e.parentElement.outerHTML).join(""),1<t.length&&(s.querySelector("#"+("watchList"===s.id?"shows":"favorites")).innerHTML=a)};s.querySelector("#actions #sortAZ").addEventListener("click",()=>e("AZ")),s.querySelector("#actions #sortZA").addEventListener("click",()=>e("ZA"))},searchList=(e,t,a)=>{const s=e.value.toLowerCase();e=a.filter(e=>e.querySelector("h3").textContent.toLowerCase().includes(s));t.querySelector("#"+("watchList"===t.id?"shows":"favorites")).innerHTML=0<e.length?e.map(e=>e.parentElement.outerHTML).join(""):`<div class="flex-1 flex flex-col items-center justify-center col-span-5 ml-[50%]  -translate-x-1/2 ">
      <img src="/imgs/no_result.png" alt="" class="w-52" />
      <h2 class="text-xl font-bold text-textColor2">No Results Found</h2>
      </div>
      `},showSearchInput=(e,t,a,s)=>{1<a[e.dataset["current_"+s]]["watchList"===e.id?"shows":"list"].size&&t.classList.toggle("show"),t.placeholder="watchList"===e.id?"Search for shows":`Search for favorite ${e.dataset["current_"+s]}
  `,t.classList.contains("show")?t.focus():t.blur(),t.classList.contains("show")?document.querySelector("#actions:not(.hidden) #search").classList.replace("fa-magnifying-glass-plus","fa-magnifying-glass-minus"):document.querySelector("#actions:not(.hidden) #search").classList.replace("fa-magnifying-glass-minus","fa-magnifying-glass-plus")},hideSearchInput=e=>{e&&(e.value=""),e?.classList.remove("show"),document.querySelector("#actions:not(.hidden) #search").classList.replace("fa-magnifying-glass-minus","fa-magnifying-glass-plus")},updateLocalStorageOrDatabase=async(t,a)=>{const s="Favorites"===t?"list":"watchList"===t?"shows":"episodes";try{const o=await checkIfUserIsLoggedIn();a.forEach(e=>{updateDoc(doc(db,t,o.uid),{[e.name]:[...e[s]]})})}catch(e){a.forEach(e=>{window.localStorage.setItem(e.name,[...e[s]])})}},retrieveFromLocalStorageOrDatabase=async(t,a)=>{const s="Favorites"===t?"list":"watchList"===t?"shows":"episodes";try{var e=await checkIfUserIsLoggedIn();return getDoc(doc(db,t,e.uid)).then(e=>(e.exists()&&(a[s]=new Set(e.data()[a.name])),Promise.resolve(a)))}catch(e){t=window.localStorage.getItem(a.name)?.split(",");return t&&""==t[0]&&t.splice(0,1),a[s]=new Set(t),Promise.resolve(a)}},storeInLocalStorageOrDatabase=async(a,s)=>{try{const o=await checkIfUserIsLoggedIn();for(let t of s)getDoc(doc(db,a,o.uid)).then(e=>{e.exists()?e.data()[t]||updateDoc(doc(db,a,o.uid),{[t]:[]}):setDoc(doc(db,a,o.uid),{[t]:[]})})}catch(e){s.forEach(e=>{window.localStorage.getItem(e)||window.localStorage.setItem(e,"")})}},checkIfUserIsLoggedIn=()=>new Promise((t,a)=>{onAuthStateChanged(auth,e=>{e?t(e):a("User is not logged in")})}),displayUserInfo=async t=>{var e=await(await fetch(`https://ui-avatars.com/api/?name=${t.displayName}&background=D4D4D4&rounded=true&size=128&bold=true&color=130F40`)).blob();const a=URL.createObjectURL(e);document.getElementById("username").innerText=t.displayName,document.getElementById("accountDetails_form").firstName.value=t.displayName.split(" ")[0],document.getElementById("accountDetails_form").lastName.value=t.displayName.split(" ")[1],document.getElementById("email").innerText=document.getElementById("accountDetails_form").email.value=t.email,document.querySelectorAll(".avatar").forEach(e=>e.src=t.photoURL||a)},handleUserAuth=()=>{const t=document.getElementById("sign"),a=document.getElementById("signOut_confirmation");onAuthStateChanged(auth,e=>{if(e){if(!e.emailVerified&&("/"===window.location.pathname||"/index.html"===window.location.pathname)){if(document.cookie.includes("emailSent=true"))return;sendEmailVerification(e).then(()=>{showMessage("A verification email has been sent to your email address. Please check your inbox and click the verification link to verify your email.","info"),document.cookie="emailSent=true; max-age=86400; path=/"})}displayUserInfo(e),t.innerHTML=`
        <i class="fa-solid fa-sign-out text-2xl"></i>
        <span class="font-semibold">Sign Out</span>
        `,t.dataset.sign="out",window.localStorage.clear(),document.getElementById("syncInfo").classList.add("hidden"),document.getElementById("syncInfo").nextElementSibling.classList.add("hidden")}else t.innerHTML=`
       <i class="fa-solid fa-sign-in text-2xl"></i>
       <span class="font-semibold">Sign In</span>
       `,t.dataset.sign="in",a.classList.remove("show"),document.getElementById("username").innerText="Guest",document.getElementById("email").innerText="",document.querySelectorAll(".avatar").forEach(e=>e.src="/imgs/no profile.png"),document.getElementById("syncInfo").classList.remove("hidden"),document.getElementById("syncInfo").nextElementSibling.classList.remove("hidden")}),document.addEventListener("click",e=>{e.target.closest("#sign")&&("in"===e.target.closest("#sign").dataset.sign?window.location.href="/authentication":a.classList.replace("-bottom-24","bottom-0"))}),a.addEventListener("click",e=>{"BUTTON"===e.target.tagName&&a.classList.replace("bottom-0","-bottom-24"),"yes"===e.target.id&&(signOut(auth),window.location.href="/")})},handleAccount=async()=>{const t=document.getElementById("account"),a=document.getElementById("verify_user_container"),s=(document.getElementById("account_toggler").addEventListener("click",()=>{if(auth.currentUser){const e=document.getElementById("emailNotVerified");auth.currentUser.emailVerified||e.classList.replace("hidden","flex"),e.querySelector("button").addEventListener("click",()=>{sendEmailVerification(auth.currentUser).then(()=>{showMessage("A verification email has been sent to your email address. Please check your inbox and click the verification link to verify your email.","info"),e.classList.replace("flex","hidden")})}),t.classList.add("show")}else window.location.href="/authentication"}),t.addEventListener("click",e=>{e.target.closest("#close_account")&&t.classList.remove("show")}),a.addEventListener("click",function(e){e.target.closest("#close")&&("save"===n.value&&h(),this.classList.remove("show"))}),async t=>{a.querySelector("form").addEventListener("submit",function(e){e.preventDefault(),""===this.email.value?showMessage("Please enter your email","error"):""===this.password.value?showMessage("Please enter your password","error"):(e=EmailAuthProvider.credential(this.email.value,this.password.value),reauthenticateWithCredential(auth.currentUser,e).then(()=>{a.classList.remove("show"),this.reset(),t()}).catch(e=>showMessage(getSignInErrorMessage(e.code),"error")))})}),o=(showPassword(),document.getElementById("accountDetails_form")),n=o.action,r=t.querySelector("#change_picture"),i=t.querySelector("[name='Image']"),c=o.querySelectorAll("input"),l=o.querySelector("button"),d=t.querySelector("img"),u=t.querySelector("#cancel");const h=(e=!1)=>{n.value="edit",l.textContent="Edit Details",c.forEach(e=>{e.setAttribute("readonly","readonly")}),r.classList.replace("grid","hidden"),u.classList.replace("block","hidden"),e||displayUserInfo(auth.currentUser)};o.addEventListener("submit",async function(e){e.preventDefault(),"edit"===n.value?(n.value="save",l.textContent="Save Changes",c.forEach(e=>{e.removeAttribute("readonly")}),r.classList.replace("hidden","grid"),u.classList.replace("hidden","block"),i.addEventListener("change",async()=>{var a,e=i.files[0];e.type.startsWith("image/")?d.src=(a=e,await new Promise(t=>{var e=new FileReader;e.addEventListener("load",e=>{t(e.target.result)}),e.readAsDataURL(a)})):d.src="/imgs/no profile.png"})):"save"===n.value&&([...document.querySelectorAll("#accountDetails_form input")].some(e=>""==e.value)?showMessage("Please fill in all the fields","error"):(a.querySelector("#action").textContent="updating your information",a.classList.add("show"),s(async()=>{var s,e=d.src.includes("http")?d.src:(s=d.src,await new Promise((t,e)=>{var a=auth.currentUser;a&&a.uid?(a=ref(getStorage(),`usersProfiles/${a.uid}.png`),uploadString(a,s,"data_url").then(e=>{getDownloadURL(e.ref).then(e=>t(e))})):e(new Error("User not logged in or UID not available."))}));updateProfile(auth.currentUser,{displayName:o.firstName.value+" "+o.lastName.value,photoURL:e}),updateEmail(auth.currentUser,o.email.value),h(!0),showMessage("Your account details have been updated successfully")})))}),u.addEventListener("click",()=>h());var e=document.getElementById("changePassword_form");isValidPassword(),e.addEventListener("submit",function(e){e.preventDefault(),""===this.password.value?showMessage("Please enter your new password","error"):""===this.confirmNewPassword.value?showMessage("Please confirm your new password","error"):isValidPassword()?this.password.value!==this.confirmNewPassword.value?showMessage("Passwords don't match","error"):(a.querySelector("#action").textContent="changing your password",a.classList.add("show"),s(async()=>{updatePassword(auth.currentUser,this.password.value).then(()=>{showMessage("Your password has been changed successfully","info"),this.reset()}).catch(e=>showMessage(e.message,"error"))})):showMessage("Password is too weak. Please choose a stronger password.","error")}),document.getElementById("reset_password").addEventListener("click",()=>{sendPasswordResetEmail(auth,auth.currentUser.email).then(()=>showMessage("A password reset email has been sent to your email address","info")).catch(e=>{let t;switch(e.code){case"auth/network-request-failed":t="Please check your internet connection and try again";break;case"auth/too-many-requests":t="Too many requests. Please try again later";break;default:t="Something went wrong. Please try again later"}showMessage(t,"error")})});const m=document.getElementById("account_linking"),g=()=>{m.querySelector("p").textContent="Link your account to your Google account to be able to login with your Google account. You can unlink your account at any time.",m.querySelector("button").textContent="Link Account"},w=()=>{m.querySelector("p").textContent="Unlinking your account from your Google account will prevent you from logging in with your Google account. You can link your account again at any time.",m.querySelector("button").textContent="Unlink Account"};try{var p=await checkIfUserIsLoggedIn();(1<p.providerData.length?w:g)(),1===p.providerData.length&&"google.com"===p.providerData[0].providerId?(m.classList.add("hidden"),m.nextElementSibling.classList.add("border-y","border-nobleDark500")):(m.classList.remove("hidden"),m.nextElementSibling.classList.remove("border-y","border-nobleDark500"))}catch(e){}m.querySelector("button").addEventListener("click",()=>{1<auth.currentUser.providerData.length?(w(),unlink(auth.currentUser,"google.com").then(()=>{showMessage("Your account has been unlinked successfully","info"),g()})):(g(),linkWithPopup(auth.currentUser,new GoogleAuthProvider).then(()=>{showMessage("Your account has been linked successfully","info"),w()}).catch(e=>{let t;switch(e.code){case"auth/popup-closed-by-user":t="Popup was closed by the user before the linking process could be completed.";break;case"auth/popup-blocked":t="Popup was blocked by the browser. Please ensure popups are allowed.";break;case"auth/account-exists-with-different-credential":t="An account with different credentials already exists. You might need to link accounts.";break;case"auth/credential-already-in-use":t="Credentials are already in use. The provided credentials are associated with another account.";break;case"auth/operation-not-allowed":t="Account linking is not allowed. Please contact support for assistance.";break;case"auth/internal-error":t="An internal error occurred during the linking process. Please try again later.";break;default:t="An error occurred while linking accounts. Please try again."}showMessage(t,"error")}))}),document.getElementById("delete_account").addEventListener("click",async()=>{a.querySelector("#action").textContent="deleting your account",a.classList.add("show"),s(async()=>{var e=getStorage();Promise.all([["Favorites","watchList","Episodes"].map(e=>{deleteDoc(doc(db,e,auth.currentUser.uid))},deleteObject(ref(e,`usersProfiles/${auth.currentUser.uid}.png`)))]).then(()=>{auth.currentUser.delete().then(()=>{showMessage("Your account has been deleted successfully","info"),window.location.href="/"}).catch(e=>showMessage(e.message,"error"))})})})};export{showPassword,isValidPassword,showMessage,checkIfUserIsLoggedIn,handleUserAuth,handleAccount,toggleList,closeList,displayShow,displayList,removeFromList,clearList,sortList,searchList,showSearchInput,hideSearchInput,updateLocalStorageOrDatabase,retrieveFromLocalStorageOrDatabase,storeInLocalStorageOrDatabase};