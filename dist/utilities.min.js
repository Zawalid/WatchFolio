import{auth,onAuthStateChanged,sendEmailVerification,sendPasswordResetEmail,signOut,updateProfile,updateEmail,updatePassword,getStorage,ref,uploadString,getDownloadURL,reauthenticateWithCredential,EmailAuthProvider,getSignInErrorMessage,db,doc,getDoc,updateDoc,setDoc,deleteDoc,deleteObject}from"/firebaseApp.min.js";const showPassword=()=>{document.querySelectorAll(".password_input").forEach(t=>{const s=t.nextElementSibling;document.addEventListener("click",e=>{"show_password"===e.target.id&&("password"==t.type&&""!=t.value?(t.type="text",s.className="fa-solid fa-eye-slash absolute z-30 right-3 top-1/2 cursor-pointer text-sm text-textColor2"):(t.type="password",s.className="fa-solid fa-eye absolute z-30 right-3 top-1/2 cursor-pointer text-sm text-textColor2")),t?.contains(e.target)||s?.contains(e.target)||"text"!=t?.type||(t.type="password",s.className="fa-solid fa-eye absolute z-30 right-3 top-1/2 cursor-pointer text-sm text-textColor2")})})},isValidPassword=()=>{var e=document.querySelector("[name='password']");const t=document.getElementById("chars_long_validation"),s=document.getElementById("special_chars_validation"),a=document.getElementById("numbers_validation"),o=document.getElementById("uppercase_validation"),r=document.getElementById("lowercase_validation"),n="fa-regular fa-check-circle text-red-300 mr-3";return e.addEventListener("input",function(){function e(e,t){t.className=e?"fa-solid fa-check-circle text-green-500  mr-3":n}e(8<=this.value.length,t),e(this.value.match(/[^a-zA-Z0-9]/g),s),e(this.value.match(/[0-9]/g),a),e(this.value.match(/[A-Z]/g),o),e(this.value.match(/[a-z]/g),r)}),t.className!==n&&s.className!==n&&a.className!==n&&o.className!==n&&r.className!==n},showMessage=(e,t)=>{const s=document.getElementById("message");"error"===t?s.classList.replace("bg-thirdAccent","bg-red-700"):s.classList.replace("bg-red-700","bg-thirdAccent"),s.textContent=e,s.classList.replace("-top-1/2","top-5"),setTimeout(()=>{s.classList.replace("top-5","-top-1/2")},4e3)},handleConnection=()=>{const e=document.getElementById("connectionStatus"),t=()=>{e.classList.replace("-bottom-14","bottom-3"),setTimeout(()=>{e.classList.replace("bottom-3","-bottom-14")},3e3)};window.addEventListener("online",()=>{e.lastElementChild.innerText="Back online",e.classList.replace("text-textColor2","text-primaryAccent"),t()}),window.addEventListener("offline",()=>{e.lastElementChild.innerText="You are offline",e.classList.replace("text-primaryAccent","text-textColor2"),t()})},toggleList=(handleConnection(),(e,t,s,a)=>{document.querySelectorAll("#"+e).forEach(e=>{e.addEventListener("click",function(){"watchList"===t.id?a("watched"):a("shows"),t.classList.toggle("show"),this.classList.add("active"),!t.classList.contains("show")&&window.location.pathname.includes("show.html")?document.body.classList.remove("h-screen","overflow-hidden"):document.body.classList.remove("overflow-hidden"),window.matchMedia("(max-width: 768px)").matches?(document.getElementById("nav").appendChild(s),s.classList.toggle("hidden")):(t.appendChild(s),s.classList.remove("hidden")),window.matchMedia("(max-width: 768px)").matches&&(window.scrollTo(0,0),t.classList.contains("show"))&&document.body.classList.add("h-screen","overflow-hidden")})})}),closeList=(t,s,a,o)=>{document.addEventListener("click",e=>{s.contains(e.target)||e.target.closest("#"+t)||e.target.closest("#downloadList")||a.contains(e.target)||(s.classList.remove("show"),a.classList.add("hidden"),document.querySelectorAll("#"+t).forEach(e=>{e.classList.remove("active")}),"watchList"===s.id?o("watched"):o("shows"))})},displayShow=async(e,t)=>{e=await(await fetch("https://api.tvmaze.com/shows/"+e)).json();return`
  <div class="flex items-center justify-between" >
<a href="show.html?id=${e.id}" class="flex items-center gap-3 " data-id="${e.id}" >
<img src="${e.image?.medium||"imgs/placeholder.png"}" alt="" class="w-[100px] rounded-lg" >
<h3 class="text-textColor font-bold text-lg">${e.name} </h3>
</a>
<i class="fa-solid fa-trash text-textColor2 transition-colors hover:text-secondaryAccent duration-300 text-lg cursor-pointer" id="${"favoritesList"===t.id?"removeFromFavoriteList":"removeFromWatchList"}"></i>
</div>
`},displayList=(t,s,a,o)=>{t.forEach(e=>{e.addEventListener("click",function(){t.forEach(e=>e.classList.remove("active")),this.classList.add("active"),s.dataset["current_"+a]=this.dataset[a],o(this.dataset[a])})})},removeFromList=(s,a,o,r,n,i)=>{document.addEventListener("click",e=>{if(e.target.closest("#"+s)){e=e.target.closest("#"+s).previousElementSibling.dataset.id;const t=a.dataset["current_"+o];window.location.href.includes("show.html?id="+e)&&document.querySelectorAll(`#overview button[data-${o}]`).forEach(e=>{e.dataset[o]==t&&(e.innerHTML=r[t].defaultButton||r.defaultButton)}),i(e,r[t]),n(t)}})},clearList=(a,o,r,n)=>{const i=a.querySelector("#clear_confirmation");a.querySelector("#actions #clear").addEventListener("click",()=>{const s="watchList"===a.id?"shows":"list";0<o[a.dataset["current_"+r]][s].size&&i.classList.replace("hidden","flex"),i.addEventListener("click",e=>{if(e.target.closest("#no")&&i.classList.replace("flex","hidden"),e.target.closest("#yes")){i.classList.replace("flex","hidden");const t=a.dataset["current_"+r];window.localStorage.setItem(t,""),o[t][s].clear(),n(t),window.location.pathname.includes("show.html")&&document.querySelectorAll("#overview button").forEach(e=>{e.dataset[r]==t&&(e.innerHTML=o[t].defaultButton||o.defaultButton)})}})})},sortList=o=>{const e=e=>{const t=[...o.querySelectorAll("[data-id]")];let s=[],a;a="AZ"===e?t.map(e=>e.querySelector("h3").textContent).toSorted():t.map(e=>e.querySelector("h3").textContent).toSorted().toReversed();t.forEach(e=>{s.push(t.find(e=>e.querySelector("h3").textContent==a[0]).parentElement),a.shift()});e=s.map(e=>e.outerHTML).join("");0<s.length&&(o.querySelector("#"+("watchList"===o.id?"shows":"favorites")).innerHTML=e)};o.querySelector("#actions #sortAZ").addEventListener("click",()=>e("AZ")),o.querySelector("#actions #sortZA").addEventListener("click",()=>e("ZA"))},searchList=(e,t,s)=>{const a=e.value.toLowerCase();e=s.filter(e=>e.querySelector("h3").textContent.toLowerCase().includes(a));t.querySelector("#"+("watchList"===t.id?"shows":"favorites")).innerHTML=0<e.length?e.map(e=>e.parentElement.outerHTML).join(""):`<div class="flex-1 flex flex-col items-center justify-center col-span-5 ml-[50%]  -translate-x-1/2 ">
      <img src="imgs/no_result.png" alt="" class="w-52" />
      <h2 class="text-xl font-bold text-textColor2">No Results Found</h2>
      </div>
      `},showSearchInput=(e,t,s,a)=>{0<s[e.dataset["current_"+a]]["watchList"===e.id?"shows":"list"].size&&t.classList.toggle("show"),t.placeholder="watchList"===e.id?"Search for shows":`Search for favorite ${e.dataset["current_"+a]}
  `,t.classList.contains("show")?t.focus():t.blur(),t.classList.contains("show")?document.querySelector("#actions #search").classList.replace("fa-magnifying-glass-plus","fa-magnifying-glass-minus"):document.querySelector("#actions #search").classList.replace("fa-magnifying-glass-minus","fa-magnifying-glass-plus")},hideSearchInput=(e,t)=>{t.value="",t.classList.remove("show"),document.querySelector("#actions #search").classList.replace("fa-magnifying-glass-minus","fa-magnifying-glass-plus")},updateLocalStorageOrDatabase=async(t,s)=>{const a="Favorites"===t?"list":"watchList"===t?"shows":"episodes";try{const o=await checkIfUserIsLoggedIn();s.forEach(e=>{updateDoc(doc(db,t,o.uid),{[e.name]:[...e[a]]})})}catch(e){s.forEach(e=>{window.localStorage.setItem(e.name,[...e[a]])})}},retrieveFromLocalStorageOrDatabase=async(t,s)=>{const a="Favorites"===t?"list":"watchList"===t?"shows":"episodes";try{var e=await checkIfUserIsLoggedIn();return getDoc(doc(db,t,e.uid)).then(e=>(e.exists()&&(s[a]=new Set(e.data()[s.name])),Promise.resolve(s)))}catch(e){t=window.localStorage.getItem(s.name)?.split(",");return t&&""==t[0]&&t.splice(0,1),s[a]=new Set(t),Promise.resolve(s)}},storeInLocalStorageOrDatabase=async(s,a)=>{try{const o=await checkIfUserIsLoggedIn();for(let t of a)getDoc(doc(db,s,o.uid)).then(e=>{e.exists()?e.data()[t]||updateDoc(doc(db,s,o.uid),{[t]:[]}):setDoc(doc(db,s,o.uid),{[t]:[]})})}catch(e){a.forEach(e=>{window.localStorage.getItem(e)||window.localStorage.setItem(e,"")})}},checkIfUserIsLoggedIn=()=>new Promise((t,s)=>{onAuthStateChanged(auth,e=>{e?t(e):s("User is not logged in")})}),displayUserInfo=async t=>{var e=await(await fetch(`https://ui-avatars.com/api/?name=${t.displayName}&background=D4D4D4&rounded=true&size=128&bold=true&color=130F40`)).blob();const s=URL.createObjectURL(e);document.getElementById("username").innerText=t.displayName,document.getElementById("accountDetails_form").firstName.value=t.displayName.split(" ")[0],document.getElementById("accountDetails_form").lastName.value=t.displayName.split(" ")[1],document.getElementById("email").innerText=document.getElementById("accountDetails_form").email.value=t.email,document.querySelectorAll(".avatar").forEach(e=>e.src=t.photoURL||s);try{(await fetch(t.photoURL,{mode:"no-cors"})).ok||document.querySelectorAll(".avatar").forEach(e=>e.src=s)}catch(e){}},handleUserAuth=async()=>{var t=document.getElementById("sign");const s=document.getElementById("signOut_confirmation");try{var e=await checkIfUserIsLoggedIn();if(!e.emailVerified&&("/"===window.location.pathname||"/index.html"===window.location.pathname)){if(document.cookie.includes("emailSent=true"))return;sendEmailVerification(e).then(()=>{showMessage("A verification email has been sent to your email address. Please check your inbox and click the verification link to verify your email.","info"),document.cookie="emailSent=true; max-age=86400; path=/"})}displayUserInfo(e),t.innerHTML=`
    <i class="fa-solid fa-sign-out text-2xl"></i>
    <span class="font-semibold">Sign Out</span>
    `,t.dataset.sign="out",window.localStorage.clear()}catch(e){t.innerHTML=`
   <i class="fa-solid fa-sign-in text-2xl"></i>
   <span class="font-semibold">Sign In</span>
   `,t.dataset.sign="in",s.classList.remove("show"),document.getElementById("username").innerText="Guest",document.getElementById("email").innerText="",document.querySelectorAll(".avatar").forEach(e=>e.src="imgs/no profile.png")}document.addEventListener("click",e=>{e.target.closest("#sign")&&("in"===e.target.closest("#sign").dataset.sign?window.location.href="./authentication.html":s.classList.replace("-bottom-24","bottom-0"))}),s.addEventListener("click",e=>{"BUTTON"===e.target.tagName&&s.classList.replace("bottom-0","-bottom-24"),"yes"===e.target.id&&(signOut(auth),window.location.href="./index.html")})},handleAccount=()=>{const t=document.getElementById("account"),s=document.getElementById("verify_user_container"),a=(document.getElementById("account_toggler").addEventListener("click",()=>{if(auth.currentUser){const e=document.getElementById("emailNotVerified");auth.currentUser.emailVerified||e.classList.replace("hidden","flex"),e.querySelector("button").addEventListener("click",()=>{sendEmailVerification(auth.currentUser).then(()=>{showMessage("A verification email has been sent to your email address. Please check your inbox and click the verification link to verify your email.","info"),e.classList.replace("flex","hidden")})}),window.scrollTo(0,0),document.body.classList.add("h-screen","overflow-hidden"),t.classList.add("show")}else window.location.href="/authentication.html"}),t.addEventListener("click",e=>{e.target.closest("#close_account")&&(window.location.href.includes("show.html")?document.body.classList.remove("h-screen","overflow-hidden"):document.body.classList.remove("overflow-hidden"),t.classList.remove("show"))}),s.addEventListener("click",function(e){e.target.closest("#close")&&("save"===r.value&&h(),this.classList.remove("show"))}),async t=>{s.querySelector("form").addEventListener("submit",function(e){e.preventDefault(),""===this.email.value?showMessage("Please enter your email","error"):""===this.password.value?showMessage("Please enter your password","error"):(e=EmailAuthProvider.credential(this.email.value,this.password.value),reauthenticateWithCredential(auth.currentUser,e).then(()=>{s.classList.remove("show"),this.reset(),t()}).catch(e=>showMessage(getSignInErrorMessage(e.code),"error")))})}),o=(showPassword(),document.getElementById("accountDetails_form")),r=o.action,n=t.querySelector("#change_picture"),i=t.querySelector("[name='Image']"),c=o.querySelectorAll("input"),l=o.querySelector("button"),d=t.querySelector("img"),u=t.querySelector("#cancel");const h=(e=!1)=>{r.value="edit",l.textContent="Edit",c.forEach(e=>{e.setAttribute("readonly","readonly")}),n.classList.replace("grid","hidden"),u.classList.replace("block","hidden"),e||displayUserInfo(auth.currentUser)};o.addEventListener("submit",async function(e){e.preventDefault(),"edit"===r.value?(r.value="save",l.textContent="Save Changes",c.forEach(e=>{e.removeAttribute("readonly")}),n.classList.replace("hidden","grid"),u.classList.replace("hidden","block"),i.addEventListener("change",async()=>{var s,e=i.files[0];e.type.startsWith("image/")?d.src=(s=e,await new Promise(t=>{var e=new FileReader;e.addEventListener("load",e=>{t(e.target.result)}),e.readAsDataURL(s)})):d.src="imgs/no profile.png"})):"save"===r.value&&([...document.querySelectorAll("#accountDetails_form input")].some(e=>""==e.value)?showMessage("Please fill in all the fields","error"):(s.querySelector("#action").textContent="updating your information",s.classList.add("show"),a(async()=>{var a,e=d.src.includes("firebasestorage")?d.src:(a=d.src,await new Promise((t,e)=>{var s=auth.currentUser;s&&s.uid?(s=ref(getStorage(),`usersProfiles/${s.uid}.png`),uploadString(s,a,"data_url").then(e=>{getDownloadURL(e.ref).then(e=>t(e))})):e(new Error("User not logged in or UID not available."))}));updateProfile(auth.currentUser,{displayName:o.firstName.value+" "+o.lastName.value,photoURL:e}),updateEmail(auth.currentUser,o.email.value),h(!0),showMessage("Your account details have been updated successfully")})))}),u.addEventListener("click",()=>h());var e=document.getElementById("changePassword_form");isValidPassword(),e.addEventListener("submit",function(e){e.preventDefault(),""===this.password.value?showMessage("Please enter your new password","error"):""===this.confirmNewPassword.value?showMessage("Please confirm your new password","error"):isValidPassword()?this.password.value!==this.confirmNewPassword.value?showMessage("Passwords don't match","error"):(s.querySelector("#action").textContent="changing your password",s.classList.add("show"),a(async()=>{updatePassword(auth.currentUser,this.password.value).then(()=>{showMessage("Your password has been changed successfully","info"),this.reset()}).catch(e=>showMessage(e.message,"error"))})):showMessage("Password is too weak. Please choose a stronger password.","error")}),document.getElementById("reset_password").addEventListener("click",()=>{sendPasswordResetEmail(auth,auth.currentUser.email).then(()=>showMessage("A password reset email has been sent to your email address","info")).catch(e=>showMessage(e.message,"error"))}),document.getElementById("delete_account").addEventListener("click",async()=>{s.querySelector("#action").textContent="deleting your account",s.classList.add("show"),a(async()=>{var e=getStorage();Promise.all([["Favorites","watchList","Episodes"].map(e=>{deleteDoc(doc(db,e,auth.currentUser.uid))},deleteObject(ref(e,`usersProfiles/${auth.currentUser.uid}.png`)))]).then(()=>{auth.currentUser.delete().then(()=>{showMessage("Your account has been deleted successfully","info"),window.location.href="/"}).catch(e=>showMessage(e.message,"error"))})})})};export{showPassword,isValidPassword,showMessage,checkIfUserIsLoggedIn,handleUserAuth,handleAccount,toggleList,closeList,displayShow,displayList,removeFromList,clearList,sortList,searchList,showSearchInput,hideSearchInput,updateLocalStorageOrDatabase,retrieveFromLocalStorageOrDatabase,storeInLocalStorageOrDatabase};